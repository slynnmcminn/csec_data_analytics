from datetime import datetime, timedelta
from csec_data_analytics_app.models import CVEVulnerability

def get_chrome_vulnerabilities_count():
    date_120_days_ago = datetime.now() - timedelta(days=120)
    return CVEVulnerability.objects(
        vulnerabilities__product="Google Chrome",
        vulnerabilities__dateAdded__gte=date_120_days_ago
    ).count()

def get_vulnerabilities_by_attack_vector(attack_vector):
    query = CVEVulnerability.objects(vulnerabilities__cvss_vector__icontains=attack_vector)
    results = list(query)  # Convert query set to list
    print(f"Query results for {attack_vector} vector: {results}")  # Debugging
    return len(results)  # Return the count

def get_most_common_weakness_last_year():
    last_year = datetime.now().year - 1
    start_last_year = datetime(last_year, 1, 1)
    end_last_year = datetime(last_year, 12, 31)

    pipeline = [
        {"$unwind": "$vulnerabilities"},
        {"$match": {
            "vulnerabilities.dateAdded": {"$gte": start_last_year, "$lte": end_last_year}
        }},
        {"$group": {
            "_id": "$vulnerabilities.cwe",  # Assuming CWE data is stored here
            "count": {"$sum": 1}
        }},
        {"$sort": {"count": -1}},
        {"$limit": 1}
    ]

    results = list(CVEVulnerability.objects().aggregate(*pipeline))
    return results[0]['_id'] if results else None
# ... [other functions] ...

def get_top_vendor_with_known_exploits_last_year():
    last_year = datetime.now().year - 1
    start_last_year = datetime(last_year, 1, 1)
    end_last_year = datetime(last_year, 12, 31)

    pipeline = [
        {"$unwind": "$vulnerabilities"},
        {"$match": {
            "vulnerabilities.knownRansomwareCampaignUse": "Known",
            "vulnerabilities.dateAdded": {"$gte": start_last_year, "$lte": end_last_year}
        }},
        {"$group": {
            "_id": "$vulnerabilities.vendorProject",
            "count": {"$sum": 1}
        }},
        {"$sort": {"count": -1}},
        {"$limit": 1}
    ]

    results = list(CVEVulnerability.objects().aggregate(*pipeline))
    return results[0]['_id'] if results else None

from django.core.management.base import BaseCommand
import csec_data_analytics_app.utilities.vulnerability_queries as vuln_queries

class Command(BaseCommand):
    help = 'Run queries to gather information about vulnerabilities.'

    def handle(self, *args, **kwargs):
        chrome_vulnerabilities_count = vuln_queries.get_chrome_vulnerabilities_count()
        print(f"Number of Google Chrome vulnerabilities in the past 120 days: {chrome_vulnerabilities_count}")

        top_products = vuln_queries.get_top_products_with_known_exploit(top_n=50)
        print("Top 50 products with known exploits:")
        for i, product in enumerate(top_products, start=1):
            print(f"{i}: {product['_id']['vendor']} {product['_id']['product']} has {product['count']} known exploits")

network_vulnerabilities = vuln_queries.get_vulnerabilities_by_attack_vector('NETWORK')
print(f"Number of vulnerabilities with 'NETWORK' attack vector: {network_vulnerabilities}")

physical_vulnerabilities = vuln_queries.get_vulnerabilities_by_attack_vector('PHYSICAL')
print(f"Number of vulnerabilities with 'PHYSICAL' attack vector: {physical_vulnerabilities}")

most_common_weakness = vuln_queries.get_most_common_weakness_last_year()
print(f"Most common weakness last year: {most_common_weakness}")
