from datetime import datetime, timedelta
from csec_data_analytics_app.models import CVEVulnerability

def get_chrome_vulnerabilities_count():
    date_120_days_ago = datetime.now() - timedelta(days=120)
    return CVEVulnerability.objects(
        product="Google Chrome",
        dateAdded=date_120_days_ago
    ).count()

def get_physical_attack_vector_count():
    # Placeholder logic to parse the 'cvss_vector' field
    return CVEVulnerability.objects(__raw__={'cvss_vector': {'$regex': 'AV:P'}}).count()

def get_top_products_with_known_exploit(top_n):
    # Adjust field names to match your model structure
    pipeline = [
        {"$unwind": "$cpe_configurations"},  # Assuming the products are listed under 'cpe_configurations'
        {"$match": {"known_exploit": True}},  # Ensure this field exists in CVEVulnerability
        {"$group": {
            "_id": {
                "vendor": "$vendor_field",  # Replace 'vendor_field' with the actual field name
                "product": "$product_field"  # Replace 'product_field' with the actual field name
            },
            "count": {"$sum": 1}
        }},
        {"$sort": {"count": -1}},
        {"$limit": top_n}
    ]

    # Run the aggregation and return the results
    results = list(CVEVulnerability.objects().aggregate(*pipeline))
    return results
